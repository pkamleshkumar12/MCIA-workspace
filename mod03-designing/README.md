# 3. Designing integration solutions using Mule applications

### Flows

- Flows always function sychronously
    - Each event processor always outputs a Mule event, which might be the same as the input Mule event
    - Some connector operations (such as async) copy the Mule event for concurrent processing (on a new thread)
- To call event processors ********************************asynchronously,********************************  for concurrent processing, wrap them in an  ******async scope******
- A “Regular flow”. `<flow..><flow>`
    - triggered by an event source (skipped if called with flow ref)
    - optional error handler
- A “Private flow”
    - Identical to a regular flow, but no event source
        - So can only be called from within the application via flow reference, API Kit router or a DataWeave lookup function
- `<sub-flow..> <sub-flow>`
    - No event source, like a private flow
    - No error handling (uses whatever the caller defines)
    - Like a macro/ “copy paste” of the subflow code in-line to the flow ref(s) that calls it.

---

### Anypoint connectors

- Anypoint connectors ****abstract and simplify**** connections to third-party resources and other protocols
    - Connectors are **connected modules**
- Modules are extensions to the Mule runtime
    - Mule SDK allows building custom modules in a consistent way that can be shared in Anypoint Exchange
    - For a REST API, a connector is automatically generated at publish time by Anypoint Exchange via the REST Connect feature
- Both connectors and modules are built using the Mule SDK (Java or XML)

### Using an API-led development approach

- Integration application interfaces can be defined using API specifications that are more human readable that Mule application code
    - API specifications focus on the business data and operations that should be exposed between clients and external systems

### APIkit autogenerates scaffolding for Mule flows

- The autogenerated code simplifies work for the Mule developer
    - Return example responses documented in the REST API specification
    - Validates requrest data and creates responses and errors based on the REST API
    - APIKit data validate fails fast for invalid inputs without additional custom coding or validation
    
    ![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled.png)
    

### APIkit also generates an API console

- The Mule API implementation can be tested uisng API console
    - API Console is accessible via a flow embedded in teh scaffolded API implementation
    - Allows adhoc testing from web browser
        - Avoids need for a REST client
        - Provides a UI and docs from the REST API specification, like in Anypoint exchange

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%201.png)

### API-led development simplifies the interface between clients (consumers) and providers

- Clients interact with the Mule application via REST connectors
    - Hides complex details of the backend endpoints
- Mule API Implementations are REST clients use the same REST API specifications to promote parallel development
    - Both API clients and providers can share experiences and best practices in Anypoint Exchange

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%202.png)

- Exchange can automatically convert between OAS and RAML
- When you publish a web API to Exchange, the REST connect service automatically generates connectors for Mule 3 and Mule 4
    - Connectors are then available in Studio by searching Anypoint Exchange

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%203.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%204.png)

### Reflection questions

- Considering APIkit
    - How do you extend the skeleton?
    - What role can API Console play in testing?
- Considering the REST Connect connector
    - Why would you use a HTTP Request instead of a REST Connector
- How is a REST connector different from the APIkit?
- How does an APIkit and a REST connector impact the API lifecycle?

---

### Sharing connections and other configurations

- ********************************Global elements********************************  hold a named set of configuration parameters
    - These are ************shared************ by using a reference in event processors or sources
    - E.g., database connection configuration shared by database operations
    - Can hold other configuration such as paths to properties files, object stores, etc
    - Change once in the global element, and then changes apply to all Mule flow elements that reference the global element

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%205.png)

### Mule domains can share global elements across Mule applications on the same runtime

- Global configuration elements can be added to a **Mule domain project**
    - One or more Mule applications can be associated with the same Mule domain
    - A Mule domain is deployed to a Mule runtime before deploying the apps
    - Mule applications linked to the Mule domain can share its configuration
- Mule domains are not supported in CloudHub nor in Runtime Fabric
    - Single application per Mule runtime means not applicable

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%206.png)

---

### The class-loading lifecycle of Mule 4 modules

- Each Mule 4 module has an independent and isolated class-loading lifecycle
    - Supported by a sophisticated hierarchy of class loaders
    - Mechanism to isolate Java Classes and libraries used by different modules
        - Allows conflicting versions of Java libraries (with potentially the same classes and interfaces) to be used by different modules in a Mule application without conflicts
- Mule 4 users separate class loaders to isolate the Mule runtime, Mule applications, and modules from each other
- Each class loader specifies the packages (rather than classes and resources) to export as part of the module’s interface
    
    ![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%207.png)
    
    **Artifact Class Loader**
    
    A regular Java class loader pointing to the JAR files included in the extension. This class loader loads all files and classes of the extension.
    
    **Artifact Filtering Class Loader**
    
    A wrapper created over the Artifact class loader, which enforces access restrictions to the extension code for foreign artifacts (the app or other plugins). It uses the content of the `mule-artifact.json` descriptor to determine what is public.
    
    **Extension Code**
    
    The Mule extension code. Uses the Artifact class loader (which does not have any restriction), and it is only able to locate resources of the plugin itself.
    
    **Application Code**
    
    The Mule app code. It uses the Artifact Filtering class loader of the extension to prevent the app from accessing restricted code or resources.
    
    ![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%208.png)
    

### The Mule HTTP connectors uses Project Grizzly libraries internally

- ****************Grizzly****************  is a standard open source library supporting the HTTPS protocols
- Uses **************selector************** thread pools
    - Selector threads check the state of the NIO channels and create and dispatch events when they arrive
    - Listener selectors poll only for ****************************request events****************************
    - Requester selectors poll only for ******************************response events******************************
- HTTP Listener has a **************shared selector pool************** for all Mule applications deployed to a particular Mule runtime
- HTTP Requester has a ******dedicated selector pool****** for each Mule application

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%209.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2010.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2011.png)

---

# Triggering Mule flows internally without any external events

- A **********************Scheduler**********************  event source can trigger a flow at a specific time
    - Fixed Frequency
    - Cron

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2012.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2013.png)

---

### How errors are generated in flows

- Each event processor might throw an error
    - The error might originate from Java code (or a called library) in the event processor or from a DataWeave expression for the inputs
- If an error is not handled, the error message is logged and the flow processing stops
    - If the flow has an event source, a response error message is usually return
- Many Mule components allow mapping errors to a new type
- The new type is a ****************************************custom namespace**************************************** and ********************error type********************
    - Allows the error to abstract and apply context to underlying failures
- ************Raise Error************ can throw a standard or custom error type
- The error type must be
    - A core Mule runtime error
        - Example: MULE:CONNECTIVITY
            
            ```java
            <raise-error type="MULE:CONNECTIVITY" description="Error description message"/>
            
            ```
            
    - A custom error type
        - Example: ORDER:INVALID_DATA
    

### Where an error handler can be added in a Mule application

- An error handler can only be added to
    - A global error handler (outside of any flows)
    - A flow
    - A Try scope
    - Not to subflows
    

### How default error handling works

- If there is no error handler defined for a flow or Try scope, a ********************************************************Mule default error handler******************************************************** is used
    - Implicitly and globally handles all messaging errors thrown in Mule applications
    - Stops execution of the flow and logs information about the error
    - Automatically rethrows the error
    - Cannot be configured

### Comparing the two types of error scopes

- On **Error Propagate** scope
    - All processors in the error handling scope are executed
    - At the end of the scope
        - The rest of the flow that threw the error is not executed
        - The error is rethrown up to the next level and handled there
    - If the erring flow starts with an HTTP Listener, it returns an **********error********** (5xx) response
- ********On Error Continue******** scope
    - All processors in the error handling scope are executed
    - At the end of the scope
        - The rest of the flow that threw the error is not executed
        - The result of the error handler scope is passed up to the next level as if the flow execution has completed successfully
    - If the erring flow starts with the HTTP Listener, it returns a **************************success (2xx)************************** response
    

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2014.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2015.png)

### Grouping event processors with a Try scope

- Acts like a private flow inside the parent block of code
    - Can have its own error handling
    - Unhandled or propagate errors bubble up (out) to the parent flow

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2016.png)

### When and how the system error handler is used

- When an error does not involve a Mule event, they system error handler is invoked
    - Examples
        - The Mule runtime has errors while starting up, like running out of memory
        - The connection for a Database connector goes offline or the network disconnects
- The system error handler
    - Logs the error
    - Executes the connector’s reconnection strategy if the error was caused by a connection failure
- These system errors are ********not******** caught by any flow or Try scope’s error scopes nor by any configured global error handlers

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2017.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2018.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2019.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2020.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2021.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2022.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2023.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2024.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2025.png)

![Untitled](3%20Designing%20integration%20solutions%20using%20Mule%20appli%2006f63edcb2c34ea48e4544b87bb078d5/Untitled%2026.png)